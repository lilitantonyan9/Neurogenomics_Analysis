########## GWAS QC STEPS ###############


#Final reports after genotyping analysis are recieved
#This document describes GWAS QC and association testing pipeline developed for the usage of neurogenetics lab team. All commands are provided for reproducibility and documentation purposes. Raw genotype and phenotype data are will not be shared publicly.

## Input files
#plink ped file obtained from raw final reports
#fam file obtained from clinically diagnosed samples where quantitive trait is available.
#map files obtained 

---

##1. Convert `.ped` to binary PLINK bed format

./plink --file mydata --make-bed --out mydata1

---------------------------------------
##2. Missingness - samples and variants

#2.1
./plink --bfile mydata1 --geno 0.03 --make-bed --out mydata2_1

# --geno 0.03 : Excludes SNPs that are missing in a large proportion of the subjects. SNPs with low genotype calls are removed.  

#98.3% of snps passed

#2.2
./plink --bfile mydate2_1 --mind 0.03 --make-bed --out mydata2_2

#--mind 0.03: Excludes individuals who have high rates of genotype missingness. Individual with low genotype calls are removed. 

#95.7% of samples passed QC

---------------------------------------
##3. Sex discrepancy: Remove problematic samples(30) and impute genotype sex

./plink --bfile my_data2_2 --check-sex --out sex_check

#plot the sex discrepemcy
Rscript --no-save sex_check.R


#3.1 Delete individuals with sex discrepancy.
grep "PROBLEM" mydata.sexcheck| awk '{print$1,$2}'> sex_discrepancy.txt
# This command generates a list of individuals with the status iPROBLEMi.

./plink --bfile mydata2_2 --remove sex_discrepancy.txt --make-bed --out mydata_sex
# This command removes the list of individuals with the status ìPROBLEMî.
277 males, 340 females

#2_impute sex
./plink --bfile mydata_sex --impute-sex --make-bed --out mydata3 
# This imputes the sex based on the genotype information into your data
283 males, 347 females, and 17 of unspecified sex

---------------------------------------
##4. Minor Allele Frequency (MAF)

# Select autosomal SNPs only (i.e., from chromosomes 1 to 22).
awk '{ if ($1 >= 1 && $1 <= 22) print $2 }' my_data3.bim > snp_1_22.txt
plink --bfile mydata3 --extract snp_1_22.txt --make-bed --out mydata4_1


# Generate a plot of the MAF distribution.
./plink --bfile mydata4_1 --freq mydata --out MAF_check-cc

Rscript --no-save MAF_check.R

# Remove SNPs with a low MAF frequency (this includes rare variants)
./plink --bfile mydata4_1 --maf 0.01 --make-bed --out mydata4_2

#866644 variants removed due to minor allele threshold(s)


---------------------------------------
##5. Hardy-Weinberg equilibrium (HWE): Delete SNPs which are not in HWE and check the distribution of HWE p-values of all SNPs

./plink --bfile mydata4_2 –hardy

#5.1 Selecting SNPs with HWE p-value below 0.00001, required for one of the two plot generated by the next Rscript, allows to zoom in on strongly deviating SNPs. 

awk '{ if ($9 <0.00001) print $0 }' plink.hwe>strong_snps.hwe

Rscript --no-save hwe.R


./plink --bfile mydata4_2 --hwe 1e-6 --make-bed --out mydata5

785406 variants and 647 people pass filters and QC


---------------------------------------
##6. Heterozygosity Rate: Excludes individuals with high or low heterozygosity rates. Deviations can indicate sample contamination, inbreeding. 

#exclusion of ±3 SD from the samples' heterozygosity rate mean, to generate a list of non-(highly)correlated SNPs, 

#6.1 LD Pruning
we exclude high inversion regions (inversion.txt [High LD regions]) and prune the SNPs using the command 
./plink --bfile mydata5 --exclude inversion.txt --range --indep-pairwise 50 5 0.2 --out indepSNP

# The parameters ‘50 5 0.2’ stand respectively for: the window size, the number of SNPs to shift the window at each step, and the multiple correlation coefficient for a SNP being regressed on all other SNPs simultaneously

# Note, don't delete the file indepSNP.prune.in, this will be used in further steps 
./plink --bfile mydata5 --extract indepSNP.prune.in --het --out R_check
# This file contains the pruned data set

# Plot of the heterozygosity rate distribution
Rscript --no-save check_heterozygosity_rate.R


# The following code generates a list of individuals who deviate more than 6 standard deviations from the heterozygosity rate mean
Rscript --no-save heterozygosity_outliers_list.R

# Output of the command above: fail-het-qc.txt . Adapt the file to make it compatible for PLINK, by removing all quotation marks from the file and selecting only the first two columns.

sed 's/"// g' fail-het-qc.txt | awk '{print$1, $2}'> het_fail_ind.txt

# Remove heterozygosity rate outliers.
./plink --bfile mydata5 --remove het_fail_ind.txt --make-bed --out mydata6



---------------------------------------
##7. Relatedness: # It is essential to check datasets you analyze for cryptic relatedness.
# Assuming a random population sample we are going to exclude all individuals above the pi-hat threshold of 0.2 (2nd degree relatedness)


./plink --bfile mydata6 --extract indepSNP.prune.in --genome --min 0.2 --out pihat_min0.2



# The following commands will visualize specifically these parent-offspring relations, using the z values. 

awk '{ if ($8 >0.9) print $0 }' pihat_min0.2.genome>zoom_pihat.genome

# Generate a plot to assess the type of relationship.
Rscript --no-save Relatedness.R

# Keep only unrelated individuals
./plink --bfile mydata6 --filter-founders --make-bed --out mydata7


---------------------------------------
------------------------------------------------------------------------------

#mydata7 will be used for the next step which is population stratification

